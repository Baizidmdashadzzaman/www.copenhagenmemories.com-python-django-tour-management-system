{% extends 'accounts/admin/layout.html' %}
{% load static %}

{% block page_title %}{{ feature_section.title }} - Tours{% endblock %}

{% block admin_content %}
<div class="">
    <h4 class="py-3 mb-4">
        <span class="text-muted fw-light">Management / Feature Sections /</span> {{ feature_section.title }} / Tours
    </h4>

    {% if messages %}
    <div class="row">
        <div class="col-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Add Tour Section -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Add Tour to Section</h5>
                </div>
                <div class="card-body">
                    <form action="{% url 'feature_section_add_tour' feature_section.pk %}" method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-10 mb-3">
                                <label for="tour-search" class="form-label">Search Tour</label>
                                <select class="form-select form-control" id="tour-search" name="tour_id" required>
                                    <option value="">Search for a tour...</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">Add Tour</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tours List -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-header border-bottom">
                    <h5 class="card-title mb-0">Tours in Section</h5>
                </div>
                <div class="table-responsive text-nowrap">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Tour</th>
                                <th>Added Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody class="table-border-bottom-0">
                            {% for item in tours %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <div class="d-flex justify-content-start align-items-center product-name">
                                        {% if item.tour.main_image %}
                                        <div class="avatar-wrapper me-3">
                                            <div class="avatar rounded-2 bg-label-secondary">
                                                <img src="{{ item.tour.main_image.url }}" alt="{{ item.tour.title }}" class="rounded-2">
                                            </div>
                                        </div>
                                        {% endif %}
                                        <div class="d-flex flex-column">
                                            <h6 class="text-nowrap mb-0">{{ item.tour.title }}</h6>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ item.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <form action="{% url 'feature_section_remove_tour' feature_section.pk item.tour.pk %}" method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-icon btn-text-secondary rounded-pill waves-effect waves-light" onclick="return confirm('Are you sure you want to remove this tour from the section?')">
                                            <i class="icon-base ti tabler-trash icon-22px"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-5">
                                    <div class="fs-4 text-muted">No tours added to this section yet.</div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-3">
                 <a href="{% url 'feature_section_list' %}" class="btn btn-secondary">Back to Feature Sections</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<!-- Select2 Implementation for AJAX Search -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    $('#tour-search').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search for a tour...',
        minimumInputLength: 0,
        width: '100%',
        ajax: {
            url: '{% url "search_tours_ajax" %}',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        },
        templateResult: formatTour,
        templateSelection: formatTourSelection
    });

    function formatTour (tour) {
        if (!tour.id) {
            return tour.text;
        }
        var $tour = $(
            '<span>' + 
            (tour.image ? '<img src="/media/' + tour.image + '" class="img-flag rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;" />' : '') +
            tour.text + '</span>'
        );
        return $tour;
    }

    function formatTourSelection (tour) {
        return tour.text;
    }
});
</script>
{% endblock %}
